<div class="bg-org-topo dashboard-wrapper">
  <div class="dashboard-container" *ngIf="currentUser">
    
    <!-- External User Dashboard -->
    <div *ngIf="currentUser.isExternalUser" class="external-dashboard">
      <div class="container-fluid">
      
      <!-- Page Title -->
      <div class="row mt-4 mb-3">
        <div class="col-12">
          <h2 class="page-title">Dashboard</h2>
        </div>
      </div>

      <!-- Three Module Buttons -->
      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <button mat-raised-button color="primary" class="module-button" (click)="onStartApplicationModule1()">
            Start Application - Module1
          </button>
        </div>
        <div class="col-md-4 mb-3">
          <button mat-raised-button color="primary" class="module-button" (click)="onStartApplicationModule2()">
            Start Application - Module2
          </button>
        </div>
        <div class="col-md-4 mb-3">
          <button mat-raised-button color="primary" class="module-button" (click)="onStartApplicationModule3()">
            Start Application - Module3
          </button>
        </div>
      </div>

      <!-- User Email Display -->
      <div class="row mb-3">
        <div class="col-12 text-end">
          <span class="user-info-label">User: <strong>{{ currentUser.email }}</strong></span>
        </div>
      </div>

      <!-- Tabs for Action Needed, My Applications, My Permits -->
      <div class="row">
        <div class="col-12">
          <mat-tab-group class="custom-tabs" (selectedTabChange)="onTabChange($event)">
            
            <!-- Action Needed Tab -->
            <mat-tab label="Action Needed">
              <div class="tab-content-wrapper">
                <div class="filter-section mb-3">
                  <input type="text" class="form-control filter-input" placeholder="Filter Active Tasks">
                </div>
                
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <th>Function</th>
                        <th>Task</th>
                        <th>Application Number</th>
                        <th>Application Name (Project Title)</th>
                        <th>Issuing Office</th>
                        <th>Type</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let task of actionNeededTasks">
                        <td>{{ task.function }}</td>
                        <td>{{ task.task }}</td>
                        <td>{{ task.applicationNumber }}</td>
                        <td>{{ task.applicationName }}</td>
                        <td>{{ task.issuingOffice }}</td>
                        <td>{{ task.type }}</td>
                      </tr>
                      <tr *ngIf="(actionNeededTasks?.length ?? 0) === 0 && !tasksLoading">
                        <td colspan="6" class="text-center text-muted">No tasks requiring action</td>
                      </tr>
                      <tr *ngIf="tasksLoading">
                        <td colspan="6" class="text-center text-muted">Loading tasks...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Pagination for Action Needed -->
                <mat-paginator 
                  [length]="tasksTotalElements || 0"
                  [pageSize]="tasksSize"
                  [pageSizeOptions]="[5, 10, 25, 50]"
                  [pageIndex]="tasksPage"
                  (page)="onTasksPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>
              </div>
            </mat-tab>

            <!-- My Applications Tab -->
            <mat-tab label="My Applications">
              <div class="tab-content-wrapper">
                <div class="filter-section mb-3">
                  <input type="text" class="form-control filter-input" placeholder="Filter Applications">
                </div>
                
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <th>Application Code</th>
                        <th>Application Name</th>
                        <th>Status</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let app of myApplications">
                        <td>{{ app.applicationCode }}</td>
                        <td>{{ app.applicationName }}</td>
                        <td>
                          <span class="badge" [ngClass]="getStatusBadgeClass(app.status)">
                            {{ app.status }}
                          </span>
                        </td>
                        <td>{{ app.createdAt | date:'short' }}</td>
                        <td>
                          <button mat-icon-button color="primary" title="View">
                            <mat-icon>visibility</mat-icon>
                          </button>
                          <button mat-icon-button color="accent" title="Edit" *ngIf="app.status === 'DRAFT'">
                            <mat-icon>edit</mat-icon>
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="(myApplications?.length ?? 0) === 0 && !applicationsLoading">
                        <td colspan="5" class="text-center text-muted">No applications found</td>
                      </tr>
                      <tr *ngIf="applicationsLoading">
                        <td colspan="5" class="text-center text-muted">Loading applications...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Pagination for My Applications -->
                <mat-paginator 
                  [length]="applicationsTotalElements || 0"
                  [pageSize]="applicationsSize"
                  [pageSizeOptions]="[5, 10, 25, 50]"
                  [pageIndex]="applicationsPage"
                  (page)="onApplicationsPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>
              </div>
            </mat-tab>

            <!-- My Permits Tab -->
            <mat-tab label="My Permits">
              <div class="tab-content-wrapper">
                <div class="filter-section mb-3">
                  <input type="text" class="form-control filter-input" placeholder="Filter Permits">
                </div>
                
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <th>Permit Number</th>
                        <th>Permit Type</th>
                        <th>Status</th>
                        <th>Issue Date</th>
                        <th>Expiry Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let permit of myPermits">
                        <td>{{ permit.permitNumber }}</td>
                        <td>{{ permit.permitType }}</td>
                        <td>
                          <span class="badge" [ngClass]="getStatusBadgeClass(permit.status)">
                            {{ permit.status }}
                          </span>
                        </td>
                        <td>{{ permit.issueDate | date:'shortDate' }}</td>
                        <td>{{ permit.expiryDate | date:'shortDate' }}</td>
                        <td>
                          <button mat-icon-button color="primary" title="View">
                            <mat-icon>visibility</mat-icon>
                          </button>
                          <button mat-icon-button title="Download">
                            <mat-icon>download</mat-icon>
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="(myPermits?.length ?? 0) === 0 && !permitsLoading">
                        <td colspan="6" class="text-center text-muted">No permits found</td>
                      </tr>
                      <tr *ngIf="permitsLoading">
                        <td colspan="6" class="text-center text-muted">Loading permits...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Pagination for My Permits -->
                <mat-paginator 
                  [length]="permitsTotalElements || 0"
                  [pageSize]="permitsSize"
                  [pageSizeOptions]="[5, 10, 25, 50]"
                  [pageIndex]="permitsPage"
                  (page)="onPermitsPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>
              </div>
            </mat-tab>

          </mat-tab-group>
        </div>
      </div>

    </div>
  </div>

  <!-- Internal User Dashboard (Placeholder for future) -->
  <div *ngIf="!currentUser.isExternalUser" class="internal-dashboard">
    <div class="container-fluid mt-4">
      <div class="alert alert-info">
        <h4>Internal User Dashboard</h4>
        <p>Internal user dashboard will be developed in the future.</p>
        <p><strong>User:</strong> {{ currentUser.email }}</p>
        <p><strong>Roles:</strong> {{ currentUser.roles?.join(', ') }}</p>
      </div>
    </div>
  </div>

  </div>
</div>
